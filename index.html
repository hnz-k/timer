<!DOCTYPE html>

<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Canggih & Modern</title>
    <style>
        :root {
            --font-primary: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            
            /* Dark Theme (Default) */
            --bg-dark: #121212;
            --surface-dark: #1e1e1e;
            --primary-dark: #bb86fc;
            --secondary-dark: #03dac6;
            --text-primary-dark: #e0e0e0;
            --text-secondary-dark: #b0b0b0;
            --border-dark: #333333;
            --shadow-color-dark: rgba(0, 0, 0, 0.5);
            --progress-bg-dark: rgba(255, 255, 255, 0.1);
            --progress-study-dark-start: #bb86fc;
            --progress-study-dark-end: #cf6679;
            --progress-break-dark-start: #03dac6;
            --progress-break-dark-end: #018786;
            --button-hover-bg-dark: rgba(255, 255, 255, 0.08);

            /* Light Theme */
            --bg-light: #f5f5f5;
            --surface-light: #ffffff;
            --primary-light: #6200ee;
            --secondary-light: #03dac6;
            --text-primary-light: #212121;
            --text-secondary-light: #757575;
            --border-light: #e0e0e0;
            --shadow-color-light: rgba(0, 0, 0, 0.15);
            --progress-bg-light: rgba(0, 0, 0, 0.1);
            --progress-study-light-start: #6200ee;
            --progress-study-light-end: #3700b3;
            --progress-break-light-start: #03dac6;
            --progress-break-light-end: #018786;
            --button-hover-bg-light: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-color: var(--bg-dark);
            --surface-color: var(--surface-dark);
            --primary-color: var(--primary-dark);
            --secondary-color: var(--secondary-dark);
            --text-primary-color: var(--text-primary-dark);
            --text-secondary-color: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --shadow-color: var(--shadow-color-dark);
            --progress-bg-color: var(--progress-bg-dark);
            --progress-study-start: var(--progress-study-dark-start);
            --progress-study-end: var(--progress-study-dark-end);
            --progress-break-start: var(--progress-break-dark-start);
            --progress-break-end: var(--progress-break-dark-end);
            --button-hover-bg: var(--button-hover-bg-dark);
        }

        [data-theme="light"] {
            --bg-color: var(--bg-light);
            --surface-color: var(--surface-light);
            --primary-color: var(--primary-light);
            --secondary-color: var(--secondary-light);
            --text-primary-color: var(--text-primary-light);
            --text-secondary-color: var(--text-secondary-light);
            --border-color: var(--border-light);
            --shadow-color: var(--shadow-color-light);
            --progress-bg-color: var(--progress-bg-light);
            --progress-study-start: var(--progress-study-light-start);
            --progress-study-end: var(--progress-study-light-end);
            --progress-break-start: var(--progress-break-light-start);
            --progress-break-end: var(--progress-break-light-end);
            --button-hover-bg: var(--button-hover-bg-light);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Allow header/footer content if needed */
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }

        .container {
            background-color: var(--surface-color);
            border-radius: 20px; /* Softer corners */
            box-shadow: 0 10px 30px var(--shadow-color);
            padding: 30px;
            width: 100%;
            max-width: 450px; /* Slightly smaller max-width for a sleeker look */
            text-align: center;
            position: relative;
            overflow: hidden; /* For potential future animations or effects within container */
        }

        /* Add a subtle border */
        .container-inner-border {
            border: 1px solid var(--border-color);
            border-radius: inherit; /* Match parent's border-radius */
            padding: 25px; /* Adjust padding as needed */
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8rem; /* Slightly smaller for a cleaner look */
            font-weight: 600;
            color: var(--text-primary-color);
            text-align: left;
        }

        .theme-switcher button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .theme-switcher button:hover {
            background-color: var(--button-hover-bg);
        }

        /* Mode Tabs (Study, Break, Stopwatch) */
        .mode-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background-color: var(--bg-color);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--border-color);
        }

        .mode-tab {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background-color: transparent;
            color: var(--text-secondary-color);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .mode-tab.active {
            background-color: var(--primary-color);
            color: var(--surface-color); /* Or a contrasting light color */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Timer Display & Progress Ring */
        .timer-area {
            position: relative;
            width: 220px; /* Adjusted size */
            height: 220px;
            margin: 0 auto 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        svg.progress-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-circle {
            fill: none;
            stroke-width: 14; /* Slightly thicker */
            stroke-linecap: round;
            transition: stroke-dashoffset 0.35s linear; /* Smoother transition */
        }

        .progress-circle-bg {
            stroke: var(--progress-bg-color);
        }

        .progress-circle-fg.study {
            stroke: url(#gradientStudy);
        }

        .progress-circle-fg.break {
            stroke: url(#gradientBreak);
        }
        
        .progress-circle-fg.stopwatch {
            stroke: url(#gradientStopwatch); /* For stopwatch mode */
        }

        .timer-display {
            color: var(--text-primary-color);
            font-size: 3.8rem; /* Adjusted size */
            font-weight: 700; /* Bolder for emphasis */
            letter-spacing: 1px;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px; /* Increased gap */
            margin-bottom: 25px;
        }

        .btn {
            background-color: transparent;
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 12px; /* Softer, more modern buttons */
            width: 65px;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .btn:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--surface-color); /* Or a contrasting light color */
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 90%, black);
            border-color: color-mix(in srgb, var(--primary-color) 90%, black);
            color: var(--surface-color);
        }

        .btn:active {
            transform: scale(0.96);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-icon {
            width: 28px; /* Slightly larger icons */
            height: 28px;
        }

        /* Cycles and Laps */
        .stats-display {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
            margin-bottom: 25px;
        }

        .stats-display span {
            font-weight: 600;
            color: var(--text-primary-color);
            background-color: var(--button-hover-bg);
            padding: 3px 8px;
            border-radius: 5px;
        }

        /* Settings Panel */
        .settings-panel-toggle button {
             background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }
        .settings-panel-toggle button:hover {
            background-color: var(--button-hover-bg);
        }

        .settings-panel {
            position: fixed; /* Changed from absolute to fixed for full screen overlay */
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Full height */
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent overlay */
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align panel to bottom */
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
        }

        .settings-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .settings-content {
            background-color: var(--surface-color);
            width: 100%;
            max-width: 480px; /* Consistent with container */
            padding: 25px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-color);
            max-height: 80vh; /* Limit height and allow scrolling */
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .settings-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary-color);
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-secondary-color);
            cursor: pointer;
            font-size: 1.8rem; /* Larger close icon */
        }
        .close-settings:hover {
            color: var(--primary-color);
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-primary-color);
            text-align: left;
        }

        .time-input-group, .select-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-input-group input[type="number"], .select-group select {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            font-size: 1rem;
            width: 100%; /* Ensure full width within flex item */
        }
        
        .time-input-group input[type="number"]:focus, .select-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 30%, transparent);
        }

        .setting-group .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .toggle-switch label {
            font-size: 0.95rem;
            color: var(--text-primary-color);
        }

        /* Basic Switch CSS */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .apply-btn {
            background-color: var(--primary-color);
            color: var(--surface-color);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        .apply-btn:hover {
            background-color: color-mix(in srgb, var(--primary-color) 90%, black);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px; /* Changed from top to bottom */
            left: 50%;
            transform: translateX(-50%) translateY(150%); /* Initial position for slide-up */
            background-color: var(--surface-color);
            color: var(--text-primary-color);
            border-left: 4px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* Background Bubbles (Optional - can be toggled) */
        .bg-bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none; /* Ensure bubbles don't interfere with interactions */
        }

        .bubble {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            animation: float 15s infinite ease-in-out;
        }
        .bubble:nth-child(2n) {
            background: var(--secondary-color);
            animation-duration: 20s;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) scale(0.5);
                opacity: 0;
            }
            10%, 90% {
                opacity: 0.3;
            }
            50% {
                transform: translateY(calc(-100px - 20vh)) scale(1);
                opacity: 0.6;
            }
            100% {
                transform: translateY(calc(-200px - 40vh)) scale(0.5);
                opacity: 0;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
                margin-top: 10px; /* Add some top margin on small screens */
            }
            .container-inner-border {
                padding: 20px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .theme-switcher button {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .mode-tab {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            .timer-area {
                width: 180px;
                height: 180px;
                margin-bottom: 25px;
            }
            .timer-display {
                font-size: 3rem;
            }
            .controls {
                gap: 10px;
            }
            .btn {
                width: 60px;
                height: 60px;
            }
            .btn-icon {
                width: 24px;
                height: 24px;
            }
            .settings-content {
                max-height: 90vh; /* Allow more height for settings on mobile */
                padding: 20px;
            }
            .settings-header h2 {
                font-size: 1.2rem;
            }
            .apply-btn {
                padding: 10px 15px;
            }
            .notification {
                width: calc(100% - 40px);
                max-width: 350px;
            }
        }

    </style>
</head>

<body>
    <div class="bg-bubbles" id="bgBubbles">
        <!-- Bubbles will be dynamically added by JavaScript -->
    </div>

    <div class="container">
        <div class="container-inner-border">
            <div class="header">
                <h1>Timer Fokus</h1>
                <div class="theme-switcher">
                    <button id="themeToggleBtn">
                        <span id="themeIcon">☀️</span> <!-- Sun icon for light, Moon for dark -->
                        <span id="themeText">Mode Terang</span>
                    </button>
                </div>
            </div>

            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="study">Belajar</button>
                <button class="mode-tab" data-mode="break">Istirahat</button>
                <button class="mode-tab" data-mode="stopwatch">Stopwatch</button>
            </div>

            <div class="timer-area">
                <svg class="progress-svg" viewBox="0 0 220 220">
                    <defs>
                        <linearGradient id="gradientStudy" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="var(--progress-study-start)" />
                            <stop offset="100%" stop-color="var(--progress-study-end)" />
                        </linearGradient>
                        <linearGradient id="gradientBreak" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="var(--progress-break-start)" />
                            <stop offset="100%" stop-color="var(--progress-break-end)" />
                        </linearGradient>
                        <linearGradient id="gradientStopwatch" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="var(--secondary-color)" /> <!-- Example, can be customized -->
                            <stop offset="100%" stop-color="var(--primary-color)" />
                        </linearGradient>
                    </defs>
                    <circle class="progress-circle progress-circle-bg" cx="110" cy="110" r="100" />
                    <circle class="progress-circle progress-circle-fg study" id="progressRing" cx="110" cy="110" r="100" />
                </svg>
                <div class="timer-display" id="timerDisplay">25:00</div>
            </div>

            <div class="controls">
                <button class="btn" id="resetBtn" title="Reset">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                </button>
                <button class="btn btn-primary" id="startPauseBtn" title="Mulai">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="btn-icon" id="startPauseIcon"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                </button>
                <button class="btn" id="lapBtn" title="Putaran" style="display: none;"> <!-- Hidden by default, shown for stopwatch -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                </button>
            </div>

            <div class="stats-display">
                <span id="cyclesDisplay">Siklus Belajar: <span class="cycle-count" id="cycleCount">0</span></span>
                <span id="lapsDisplay" style="display: none;">Putaran: <span id="lapCount">0</span></span>
            </div>
            
            <div class="settings-panel-toggle">
                <button id="openSettingsBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>Pengaturan</span>
                </button>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-header">
                <h2>Pengaturan Timer</h2>
                <button class="close-settings" id="closeSettingsBtn" title="Tutup Pengaturan">&times;</button>
            </div>

            <div class="setting-group">
                <label class="setting-label">Waktu Belajar (menit)</label>
                <div class="time-input-group">
                    <input type="number" id="studyTimeInput" min="1" max="180" value="25">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Waktu Istirahat Pendek (menit)</label>
                <div class="time-input-group">
                    <input type="number" id="shortBreakTimeInput" min="1" max="30" value="5">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Waktu Istirahat Panjang (menit)</label>
                <div class="time-input-group">
                    <input type="number" id="longBreakTimeInput" min="5" max="60" value="15">
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Siklus Sebelum Istirahat Panjang</label>
                <div class="time-input-group">
                    <input type="number" id="cyclesBeforeLongBreakInput" min="1" max="10" value="4">
                </div>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">Suara Alarm</label>
                <div class="select-group">
                    <select id="alarmSoundSelect">
                        <option value="none">Tanpa Suara</option>
                        <option value="ding">Ding</option>
                        <option value="bell">Bell</option>
                        <option value="chime">Chime</option>
                    </select>
                </div>
            </div>

            <div class="setting-group">
                <div class="toggle-switch">
                    <label for="autoStartTimerToggle">Mulai Otomatis Timer Berikutnya</label>
                    <label class="switch">
                        <input type="checkbox" id="autoStartTimerToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="setting-group">
                <div class="toggle-switch">
                    <label for="bubbleAnimationToggle">Animasi Gelembung Latar</label>
                    <label class="switch">
                        <input type="checkbox" id="bubbleAnimationToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <button class="apply-btn" id="applySettingsBtn">Terapkan Pengaturan</button>
        </div>
    </div>

    <div class="notification" id="notification">
        <!-- Pesan notifikasi akan muncul di sini -->
    </div>

    <audio id="alarmAudio"></audio> <!-- For playing alarm sounds -->

    <script>
// --- DOM Elements ---
const body = document.body;
const themeToggleBtn = document.getElementById("themeToggleBtn");
const themeIcon = document.getElementById("themeIcon");
const themeText = document.getElementById("themeText");

const modeTabs = document.querySelectorAll(".mode-tab");
const timerDisplay = document.getElementById("timerDisplay");
const progressRing = document.getElementById("progressRing");
const startPauseBtn = document.getElementById("startPauseBtn");
const startPauseIcon = document.getElementById("startPauseIcon"); // Corrected ID
const resetBtn = document.getElementById("resetBtn");
const lapBtn = document.getElementById("lapBtn"); // For stopwatch

const cyclesDisplay = document.getElementById("cyclesDisplay");
const cycleCountEl = document.getElementById("cycleCount");
const lapsDisplay = document.getElementById("lapsDisplay");
const lapCountEl = document.getElementById("lapCount"); // Corrected ID

const openSettingsBtn = document.getElementById("openSettingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const closeSettingsBtn = document.getElementById("closeSettingsBtn");
const applySettingsBtn = document.getElementById("applySettingsBtn");

// Settings Inputs
const studyTimeInput = document.getElementById("studyTimeInput");
const shortBreakTimeInput = document.getElementById("shortBreakTimeInput");
const longBreakTimeInput = document.getElementById("longBreakTimeInput");
const cyclesBeforeLongBreakInput = document.getElementById("cyclesBeforeLongBreakInput");
const alarmSoundSelect = document.getElementById("alarmSoundSelect");
const autoStartTimerToggle = document.getElementById("autoStartTimerToggle");
const bubbleAnimationToggle = document.getElementById("bubbleAnimationToggle");

const notificationEl = document.getElementById("notification");
const alarmAudio = document.getElementById("alarmAudio");
const bgBubblesContainer = document.getElementById("bgBubbles");

// --- Timer State & Settings ---
let currentMode = "study"; // study, break, stopwatch
let timerInterval;
let timeLeft; // in seconds
let totalTime; // for progress calculation
let isRunning = false;
let studyCycles = 0;
let currentCycleCount = 0; // for long break logic
let lapCounter = 0;

// Default Settings (can be overridden by user settings)
let settings = {
    studyTime: 25 * 60,       // 25 minutes
    shortBreakTime: 5 * 60,   // 5 minutes
    longBreakTime: 15 * 60,   // 15 minutes
    cyclesForLongBreak: 4,
    alarmSound: "ding",       // "none", "ding", "bell", "chime"
    autoStartNext: true,
    bubbleAnimation: true,
    currentTheme: "dark"      // "light", "dark"
};

const alarmSounds = {
    ding: "https://cdn.jsdelivr.net/gh/ManusaAI/manus-assets/sounds/ding.mp3",
    bell: "https://cdn.jsdelivr.net/gh/ManusaAI/manus-assets/sounds/bell.mp3",
    chime: "https://cdn.jsdelivr.net/gh/ManusaAI/manus-assets/sounds/chime.mp3"
};

// Progress Ring
const radius = progressRing.r.baseVal.value;
const circumference = 2 * Math.PI * radius;
progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
progressRing.style.strokeDashoffset = circumference;

// --- Utility Functions ---
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
}

function updateProgressRing(currentTime, totalDuration) {
    if (totalDuration <= 0) {
        progressRing.style.strokeDashoffset = 0; 
        return;
    }
    const progress = (totalDuration - currentTime) / totalDuration;
    const offset = circumference * progress;
    progressRing.style.strokeDashoffset = Math.max(0, circumference - offset); 
}

function showNotification(message, duration = 3000) {
    notificationEl.textContent = message;
    notificationEl.classList.add("show");
    setTimeout(() => {
        notificationEl.classList.remove("show");
    }, duration);
}

function playAlarmSound() {
    if (settings.alarmSound !== "none" && alarmSounds[settings.alarmSound]) {
        alarmAudio.src = alarmSounds[settings.alarmSound];
        alarmAudio.play().catch(e => console.warn("Audio play failed:", e));
    }
}

// --- Theme Management ---
function applyTheme(theme) {
    body.setAttribute("data-theme", theme);
    settings.currentTheme = theme;
    themeIcon.textContent = theme === "light" ? "🌙" : "☀️";
    themeText.textContent = theme === "light" ? "Mode Gelap" : "Mode Terang";
    localStorage.setItem("timerTheme", theme);
}

function toggleTheme() {
    const newTheme = settings.currentTheme === "light" ? "dark" : "light";
    applyTheme(newTheme);
}

// --- Bubble Animation ---
function createBubble() {
    if (!settings.bubbleAnimation || !bgBubblesContainer) return;
    const bubble = document.createElement("div");
    bubble.classList.add("bubble");
    const size = Math.random() * 30 + 10; 
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.left = `${Math.random() * 100}%`;
    bubble.style.animationDuration = `${Math.random() * 10 + 10}s`; 
    bubble.style.animationDelay = `${Math.random() * 5}s`;
    
    bgBubblesContainer.appendChild(bubble);

    setTimeout(() => {
        bubble.remove();
    }, parseFloat(bubble.style.animationDuration) * 1000 + parseFloat(bubble.style.animationDelay) * 1000 + 1000);
}

function manageBubbles() {
    if (settings.bubbleAnimation && bgBubblesContainer) {
        bgBubblesContainer.innerHTML = ""; 
        for (let i = 0; i < 15; i++) { 
            createBubble();
        }
    } else if (bgBubblesContainer) {
        bgBubblesContainer.innerHTML = ""; 
    }
}

// --- Timer Logic ---
function updateDisplay() {
    timerDisplay.textContent = formatTime(timeLeft);
    if (currentMode !== "stopwatch") {
        updateProgressRing(timeLeft, totalTime);
    }
}

function startTimer() {
    if (isRunning) return;
    isRunning = true;
    startPauseIcon.innerHTML = ".    <path d=\"M6 19h4V5H6v14zm8-14v14h4V5h-4z\"></path>"; 
    startPauseBtn.title = "Jeda";

    if (currentMode === "stopwatch") {
        totalTime = 0; 
        progressRing.style.strokeDashoffset = circumference; 
    }

    timerInterval = setInterval(() => {
        if (currentMode === "stopwatch") {
            timeLeft++;
            updateProgressRing(timeLeft % 60, 60); 
        } else {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                handleTimerEnd();
                return;
            }
            timeLeft--;
        }
        updateDisplay();
    }, 1000);
}

function pauseTimer() {
    if (!isRunning) return;
    isRunning = false;
    clearInterval(timerInterval);
    startPauseIcon.innerHTML = ".    <polygon points=\"5 3 19 12 5 21 5 3\"></polygon>"; 
    startPauseBtn.title = "Mulai";
}

function resetTimer() {
    pauseTimer();
    switch (currentMode) {
        case "study":
            timeLeft = settings.studyTime;
            totalTime = settings.studyTime;
            break;
        case "break":
            timeLeft = (currentCycleCount > 0 && currentCycleCount % settings.cyclesForLongBreak === 0) ? settings.longBreakTime : settings.shortBreakTime;
            totalTime = timeLeft;
            break;
        case "stopwatch":
            timeLeft = 0;
            totalTime = 0; 
            lapCounter = 0;
            lapCountEl.textContent = lapCounter;
            break;
    }
    updateDisplay();
    updateProgressRing(timeLeft, totalTime);
    if (currentMode === "stopwatch") progressRing.style.strokeDashoffset = circumference;
}

function handleTimerEnd() {
    playAlarmSound();
    let notificationMessage = "";

    if (currentMode === "study") {
        studyCycles++;
        currentCycleCount++;
        cycleCountEl.textContent = studyCycles;
        notificationMessage = "Waktu belajar selesai! Saatnya istirahat.";
        if (settings.autoStartNext) {
            switchMode("break");
        } else {
            showNotification(notificationMessage);
            resetTimer(); 
        }
    } else if (currentMode === "break") {
        notificationMessage = "Waktu istirahat selesai! Kembali belajar?";
        if (settings.autoStartNext) {
            switchMode("study");
        } else {
            showNotification(notificationMessage);
            resetTimer(); 
        }
    }
}

// --- Mode Switching ---
function switchMode(newMode) {
    currentMode = newMode;
    pauseTimer(); 

    modeTabs.forEach(tab => {
        tab.classList.toggle("active", tab.dataset.mode === newMode);
    });

    progressRing.classList.remove("study", "break", "stopwatch");
    progressRing.classList.add(newMode);

    if (newMode === "stopwatch") {
        lapBtn.style.display = "flex";
        cyclesDisplay.style.display = "none";
        lapsDisplay.style.display = "inline"; 
    } else {
        lapBtn.style.display = "none";
        cyclesDisplay.style.display = "inline"; 
        lapsDisplay.style.display = "none";
    }
    
    resetTimer(); 
    if (settings.autoStartNext && (newMode === "study" || newMode === "break")) {
        if (newMode === "study" && !isRunning) startTimer(); 
        if (newMode === "break" && !isRunning) startTimer(); 
    }
    showNotification(`Mode diubah ke: ${newMode.charAt(0).toUpperCase() + newMode.slice(1)}`);
}

// --- Settings Panel Logic ---
function openSettings() {
    studyTimeInput.value = settings.studyTime / 60;
    shortBreakTimeInput.value = settings.shortBreakTime / 60;
    longBreakTimeInput.value = settings.longBreakTime / 60;
    cyclesBeforeLongBreakInput.value = settings.cyclesForLongBreak;
    alarmSoundSelect.value = settings.alarmSound;
    autoStartTimerToggle.checked = settings.autoStartNext;
    bubbleAnimationToggle.checked = settings.bubbleAnimation;

    settingsPanel.classList.add("open");
}

function closeSettings() {
    settingsPanel.classList.remove("open");
}

function applyUserSettings() {
    const newStudyTime = parseInt(studyTimeInput.value) * 60;
    const newShortBreakTime = parseInt(shortBreakTimeInput.value) * 60;
    const newLongBreakTime = parseInt(longBreakTimeInput.value) * 60;
    const newCyclesForLongBreak = parseInt(cyclesBeforeLongBreakInput.value);

    if (isNaN(newStudyTime) || newStudyTime <= 0) {
        showNotification("Waktu belajar tidak valid."); return;
    }
    if (isNaN(newShortBreakTime) || newShortBreakTime <= 0) {
        showNotification("Waktu istirahat pendek tidak valid."); return;
    }
    if (isNaN(newLongBreakTime) || newLongBreakTime <= 0) {
        showNotification("Waktu istirahat panjang tidak valid."); return;
    }
    if (isNaN(newCyclesForLongBreak) || newCyclesForLongBreak <= 0) {
        showNotification("Jumlah siklus tidak valid."); return;
    }

    settings.studyTime = newStudyTime;
    settings.shortBreakTime = newShortBreakTime;
    settings.longBreakTime = newLongBreakTime;
    settings.cyclesForLongBreak = newCyclesForLongBreak;
    settings.alarmSound = alarmSoundSelect.value;
    settings.autoStartNext = autoStartTimerToggle.checked;
    settings.bubbleAnimation = bubbleAnimationToggle.checked;

    localStorage.setItem("timerSettings", JSON.stringify(settings));

    manageBubbles(); 
    resetTimer(); 
    closeSettings();
    showNotification("Pengaturan berhasil diterapkan!");
}

// --- Event Listeners ---
themeToggleBtn.addEventListener("click", toggleTheme);

startPauseBtn.addEventListener("click", () => {
    if (isRunning) {
        pauseTimer();
    } else {
        startTimer();
    }
});

resetBtn.addEventListener("click", () => {
    resetTimer();
    showNotification("Timer direset.");
});

lapBtn.addEventListener("click", () => {
    if (currentMode === "stopwatch" && isRunning) {
        lapCounter++;
        lapCountEl.textContent = lapCounter;
        showNotification(`Putaran ${lapCounter}: ${formatTime(timeLeft)}`);
    }
});

modeTabs.forEach(tab => {
    tab.addEventListener("click", () => switchMode(tab.dataset.mode));
});

openSettingsBtn.addEventListener("click", openSettings);
closeSettingsBtn.addEventListener("click", closeSettings);
applySettingsBtn.addEventListener("click", applyUserSettings);

settingsPanel.addEventListener("click", (event) => {
    if (event.target === settingsPanel) { 
        closeSettings();
    }
});

// --- Initialization ---
function loadSettings() {
    const savedTheme = localStorage.getItem("timerTheme");
    if (savedTheme) {
        applyTheme(savedTheme);
    }

    const savedSettings = localStorage.getItem("timerSettings");
    if (savedSettings) {
        try {
            const parsedSettings = JSON.parse(savedSettings);
            settings = { ...settings, ...parsedSettings };
        } catch (e) {
            console.error("Error parsing saved settings:", e);
        }
    }
}

function initializeApp() {
    loadSettings();
    applyTheme(settings.currentTheme); 
    switchMode(currentMode); 
    manageBubbles(); 
    studyTimeInput.value = settings.studyTime / 60;
    shortBreakTimeInput.value = settings.shortBreakTime / 60;
    longBreakTimeInput.value = settings.longBreakTime / 60;
    cyclesBeforeLongBreakInput.value = settings.cyclesForLongBreak;
    alarmSoundSelect.value = settings.alarmSound;
    autoStartTimerToggle.checked = settings.autoStartNext;
    bubbleAnimationToggle.checked = settings.bubbleAnimation;
}

document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
</body>
</html>